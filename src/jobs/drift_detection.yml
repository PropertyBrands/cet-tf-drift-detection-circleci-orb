description: "Run terragrunt run-all plan and send SES email on drift/failure"
circleci_ip_ranges: true
parameters:
  # Deployment details
  region:
    type: string
  account_type:
    type: string
  environment:
    type: string
  account_id:
    type: string
  # Repo structure + AWS role name
  deployments_root:
    type: string
    default: "deployments"
  role_name:
    type: string
  # Container image
  terragrunt_image:
    type: string
    default: "alpine/terragrunt:1.12.2"
  # Terragrunt exclusions
  tg_queue_exclude_dirs:
    description: "Comma-separated list of dirs to exclude from run-all"
    type: string
    default: ""
  # Email / SES
  drift_email_to:
    type: string
  drift_email_from:
    type: string
  drift_email_from_name:
    type: string
    default: "Terraform Drift Detection"
  ses_region:
    type: string
  # DRY RUN capability to test parameter/orb
  dry_run:
    type: boolean
    default: true
executor:
  name: terragrunt
  image: << parameters.terragrunt_image >>
steps:
  - checkout
  - aws-cli/setup:
      role_arn: arn:aws:iam::<< parameters.account_id >>:role/<< parameters.role_name >>
      region: << parameters.region >>
  - install_sops
  - install_misc
  - run:
      name: Run Terragrunt plan and email on drift (<< parameters.region >>/<< parameters.environment >>)
      working_directory: << parameters.deployments_root >>/<< parameters.account_type >>/<< parameters.region >>/<< parameters.environment >>
      environment:
        # ENV Vars
        REGION: << parameters.region >>
        ENVIRONMENT: << parameters.environment >>
        ACCOUNT_TYPE: << parameters.account_type >>
        ACCOUNT_ID: << parameters.account_id >>
        TG_QUEUE_EXCLUDE_DIRS: << parameters.tg_queue_exclude_dirs >>
        # Email / SES Vars
        DRIFT_EMAIL_TO: << parameters.drift_email_to >>
        DRIFT_EMAIL_FROM: << parameters.drift_email_from >>
        DRIFT_EMAIL_FROM_NAME: << parameters.drift_email_from_name >>
        SES_REGION: << parameters.ses_region >>
      command: <<include(scripts/run_drift_detection.sh)>>
